内蒙-有色白水(55161861) 9:59:05
今天不算特别忙，分享点干货，数据库设计方面的
内蒙-有色白水(55161861) 9:59:39
一般来说php面对数据库方面主要是两个难点，一个是设计，一个是架构
在盛夏゛(1004371009) 10:00:31


内蒙-有色白水(55161861) 10:00:35
前面的主要看细节和逻辑，后面的主要看大局，稳定性，安全性，侧重点不同
内蒙-有色白水(55161861) 10:01:18
架构的太大，有一些常见的套路，但是这玩意不是死的，根据业务定，今天来不及分享
内蒙-有色白水(55161861) 10:01:29
就讲设计中的一些心得
内蒙-有色白水(55161861) 10:02:43
一般说数据库设计，主要是说mysql，像其他关系型数据库，可能实现方式略有不同，但是设计原理大体相似
内蒙-有色白水(55161861) 10:03:17
数据库设计主要考虑三个问题，1实现需求，2.易扩展，3.性能越高越好
内蒙-有色白水(55161861) 10:05:17
实现需求，其实主要的工作在于如何写sql上，一般到了配置mysql，做分库分表，就成了架构向了
上海-默默(1006142164) 10:06:09
厉害
内蒙-有色白水(55161861) 10:07:46
像一些选择字段，比如是否，比如地区，比如状态等，最好的表现方式是数字，当然用枚举也可以，但是不建议这样做，因为一扩展，需要改变内置的数据类型
内蒙-有色白水(55161861) 10:07:59
而且枚举的本身的实现方式还是基于数字
上海-默默(1006142164) 10:08:28
有时候，我见好多表里都有写其他表里的字段
内蒙-有色白水(55161861) 10:08:31
数字的查询效率是比较高的，相对于文本，二进制等字段，所以字段中能数字化的最好都用数字化
内蒙-有色白水(55161861) 10:08:50
比如时间，比如ip，比如枚举类型
内蒙-有色白水(55161861) 10:09:41
像一个字段，是禁用，启用，用tinyint即可，0和1即可，当有扩展的时候，比如审核，比如删除，这样可以直接延伸出，2.3,.4....
内蒙-有色白水(55161861) 10:09:53
所以数字是最容易扩展的
内蒙-有色白水(55161861) 10:10:21
文本字段，少用大文本
内蒙-有色白水(55161861) 10:10:43
我这里的大文本字段的意思是超出255个字符的字段就可以算是大文本了
内蒙-有色白水(55161861) 10:11:26
因为走索引的文本字段不可以超过255，超过了，就放不到内存里，直接放硬盘里了
内蒙-有色白水(55161861) 10:12:24
控制字数比较重要，如果有一个表读的频率特别高，有一个大文本字段，立马速度就降下来了
内蒙-有色白水(55161861) 10:13:03
另外很多人没事爱把文件字段二进制保存到数据库里，千万不要这样做
内蒙-有色白水(55161861) 10:13:53
你可以把文件存储到web访问不了的目录里，但是不能存到数据库里，教学可以，实战这么做就很傻了
内蒙-有色白水(55161861) 10:14:26
如果是公开的文件，那直接存硬盘即可
内蒙-有色白水(55161861) 10:15:11
在符合项目需求的字段上，越小越好，能用tinyint的就用tinyint，不要用int
内蒙-有色白水(55161861) 10:15:56
像用户名，20个字符长度足够，太长没有用了，像密码，都要md5，固定32个char字符，效率最高
内蒙-有色白水(55161861) 10:16:39
一般固定长度的文本查询更快，但是空间利用效率一般，但是如果你可以控制字符数固定或者相差不多，能用char就用char
内蒙-有色白水(55161861) 10:17:10
比如md5后的密码就是32位或者16位，固定长度即可，用不着varchar
内蒙-有色白水(55161861) 10:17:50
刚才说的都是一般字段设计的要求
内蒙-有色白水(55161861) 10:17:54
说下理念
内蒙-有色白水(55161861) 10:18:09
关系型数据库，最大的贡献，就是关系
内蒙-有色白水(55161861) 10:18:24
所以活用关系就是重点
内蒙-有色白水(55161861) 10:19:23
最简单的例子，无限极分类，那么最少的设计就是，id，name，pid
内蒙-有色白水(55161861) 10:20:31
这样顶层分类就是pid为0，任何一个子分类，都是pid为父分类，一次查询出所有分类后，直接用算法进行树构造，就可以演化成无限极分类
内蒙-有色白水(55161861) 10:21:15
但是这样的设计有一个缺点，那就是索引任意一个分类的时候，没有办法直接获取子分类
樟溪<chen_zhangxi@qq.com> 10:21:37
什么意思 最后一点
内蒙-有色白水(55161861) 10:21:41
比如一个新闻类目，下面有国内新闻，国外新闻，热点新闻，3个子分类
广西 -转程序员的农民(237852401) 10:21:58
有PID还不能直接找到整个树么?
樟溪<chen_zhangxi@qq.com> 10:21:59
那有什么问题
广西 -转程序员的农民(237852401) 10:22:05
找父找子
内蒙-有色白水(55161861) 10:22:28
新闻类目id是1，pid是0，但是该类目下没有文章，需要读取子分类的文章数据，这样的场景比较常见
樟溪<chen_zhangxi@qq.com> 10:23:02
递归下 不就好了
内蒙-有色白水(55161861) 10:23:04
当然以父找子也可以啊，但是要多查询一遍
内蒙-有色白水(55161861) 10:23:24
这样就延伸出一个新的字段，path
樟溪<chen_zhangxi@qq.com> 10:23:38
那个 不好修改 
内蒙-有色白水(55161861) 10:23:56
id  name  pid path
1  新闻     0     1,2,3,4
樟溪<chen_zhangxi@qq.com> 10:24:17
递归又不是很多层 
樟溪<chen_zhangxi@qq.com> 10:24:24
我觉得没必须要吧
内蒙-有色白水(55161861) 10:24:29
path实际上包含了本身的id加子id
内蒙-有色白水(55161861) 10:24:33
不需要递归
樟溪<chen_zhangxi@qq.com> 10:24:55
这个是不需要递归 但你更新分类就麻烦了
樟溪<chen_zhangxi@qq.com> 10:25:00
操作麻烦
内蒙-有色白水(55161861) 10:25:04
这样我们搜索任意一个分类下，包含所有子分类的文章，包括孙分类，重孙分类，只要一遍
广西 -转程序员的农民(237852401) 10:25:06
加上这个path索引就快很多了
广西 -转程序员的农民(237852401) 10:25:12
soga
内蒙-有色白水(55161861) 10:25:42
那就是 用 like %字段  path
樟溪<chen_zhangxi@qq.com> 10:26:26
比如，我想改变分类的父级目录 
樟溪<chen_zhangxi@qq.com> 10:26:34
你岂不是要改变path
广西 -转程序员的农民(237852401) 10:27:04
改啊
广西 -转程序员的农民(237852401) 10:27:14
改个数据字段而已
内蒙-有色白水(55161861) 10:27:23
like的性能很低，要加索引只能从左搜索，无法任意位置搜索，这样就可以利用like索引任意查询任何一个分类下的子孙分类数据
樟溪<chen_zhangxi@qq.com> 10:27:24
那不需要path 岂不更好
内蒙-有色白水(55161861) 10:28:07
不用path就需要层层递归，回回递归，性能很差



10:25:06
广西 -转程序员的农民 2016/5/1 10:25:06
加上这个path索引就快很多了
广西 -转程序员的农民 2016/5/1 10:25:12
soga
10:25:42
内蒙-有色白水 2016/5/1 10:25:42
那就是 用 like %字段  path
樟溪 2016/5/1 10:26:26
比如，我想改变分类的父级目录 
樟溪 2016/5/1 10:26:34
你岂不是要改变path
广西 -转程序员的农民 2016/5/1 10:27:04
改啊
广西 -转程序员的农民 2016/5/1 10:27:14
改个数据字段而已
内蒙-有色白水 2016/5/1 10:27:23
like的性能很低，要加索引只能从左搜索，无法任意位置搜索，这样就可以利用like索引任意查询任何一个分类下的子孙分类数据
樟溪 2016/5/1 10:27:24
那不需要path 岂不更好
10:28:07
内蒙-有色白水 2016/5/1 10:28:07
不用path就需要层层递归，回回递归，性能很差
内蒙-有色白水 2016/5/1 10:28:25
如果有几十层分类，那完了
樟溪 2016/5/1 10:28:43
你见过几十层分类的 项目吗
内蒙-有色白水 2016/5/1 10:28:43
但是用上面这样的方法，就可以搞定
广西 -转程序员的农民 2016/5/1 10:28:50
用迭代
内蒙-有色白水 2016/5/1 10:28:51
我用过
内蒙-有色白水 2016/5/1 10:29:07
传销项目，几十层上百层的会员都不奇怪
广西 -转程序员的农民 2016/5/1 10:29:18

樟溪 2016/5/1 10:29:24
那就不是分类了
内蒙-有色白水 2016/5/1 10:29:35
一样，带层级的都是一个道理
广西 -转程序员的农民 2016/5/1 10:29:37
是分类啊
樟溪 2016/5/1 10:29:37
你那个是业务 情况
广西 -转程序员的农民 2016/5/1 10:29:42
上下层
广西 -转程序员的农民 2016/5/1 10:29:57
传销都是蹭蹭扣分子钱的
10:30:13
内蒙-有色白水 2016/5/1 10:30:13
刚才举了一个简单的设计范例
内蒙-有色白水 2016/5/1 10:30:22
再来
樟溪 2016/5/1 10:30:34
洗耳恭听 哈哈哈
内蒙-有色白水 2016/5/1 10:31:02
没有备课，完全是想到哪里讲哪里，没有章法，可能会乱点


10:28:07
内蒙-有色白水 2016/5/1 10:28:07
不用path就需要层层递归，回回递归，性能很差
内蒙-有色白水 2016/5/1 10:28:25
如果有几十层分类，那完了
樟溪 2016/5/1 10:28:43
你见过几十层分类的 项目吗
内蒙-有色白水 2016/5/1 10:28:43
但是用上面这样的方法，就可以搞定
广西 -转程序员的农民 2016/5/1 10:28:50
用迭代
内蒙-有色白水 2016/5/1 10:28:51
我用过
内蒙-有色白水 2016/5/1 10:29:07
传销项目，几十层上百层的会员都不奇怪
广西 -转程序员的农民 2016/5/1 10:29:18

樟溪 2016/5/1 10:29:24
那就不是分类了
内蒙-有色白水 2016/5/1 10:29:35
一样，带层级的都是一个道理
广西 -转程序员的农民 2016/5/1 10:29:37
是分类啊
樟溪 2016/5/1 10:29:37
你那个是业务 情况
广西 -转程序员的农民 2016/5/1 10:29:42
上下层
广西 -转程序员的农民 2016/5/1 10:29:57
传销都是蹭蹭扣分子钱的
10:30:13
内蒙-有色白水 2016/5/1 10:30:13
刚才举了一个简单的设计范例
内蒙-有色白水 2016/5/1 10:30:22
再来
樟溪 2016/5/1 10:30:34
洗耳恭听 哈哈哈
内蒙-有色白水 2016/5/1 10:31:02
没有备课，完全是想到哪里讲哪里，没有章法，可能会乱点
10:32:20
樟溪 2016/5/1 10:32:20
@内蒙-有色白水 请假个问题
内蒙-有色白水 2016/5/1 10:32:36
我们场景的场景有一对一，一对多，多对多
樟溪 2016/5/1 10:32:39
商城系统的 属性 这个你数据库怎么设计
内蒙-有色白水 2016/5/1 10:32:54
刚好你问对了
樟溪 2016/5/1 10:32:57
嗯，先听你讲
内蒙-有色白水 2016/5/1 10:33:01
我就是搞商城的
内蒙-有色白水 2016/5/1 10:33:23
属性有两个作用，一个是描述商品，一个是加入搜索
10:34:04
樟溪 2016/5/1 10:34:04
嗯，商品的sku
内蒙-有色白水 2016/5/1 10:34:09
我一般是建立个属性表
内蒙-有色白水 2016/5/1 10:34:14
和sku两码事
内蒙-有色白水 2016/5/1 10:34:24
sku是sku，属性是属性
内蒙-有色白水 2016/5/1 10:34:53
当然sku也是属性的一种，但是sku是库存属性，是销售属性，和商品的属性又不一样
内蒙-有色白水 2016/5/1 10:35:23
建立一个属性表，建立一个搜索属性表
樟溪 2016/5/1 10:35:30
比如  一双 袜子  有 黑白   成年 儿童
樟溪 2016/5/1 10:35:35
你是怎么组成的
樟溪 2016/5/1 10:35:43
估计要好几个表才可以
10:35:58
内蒙-有色白水 2016/5/1 10:35:58
说白了，全部属性进属性表，进搜索的复写一遍，当然要排除不加入搜索的
内蒙-有色白水 2016/5/1 10:36:44
这样有一个问题，就是需要先设置商品类型或者分类类型后，属性才生效，如果设置属性在前，加入搜索在后，那么有一部分商品没有办法搜到
内蒙-有色白水 2016/5/1 10:36:54
淘宝就是这么干的
内蒙-有色白水 2016/5/1 10:37:27
我变更了属性搜索，那么你的商品就需要重新编辑，哪怕没有任何更改，但是提交一遍就可以进入属性搜索
樟溪 2016/5/1 10:37:53

樟溪 2016/5/1 10:37:57
难道不是这样子
内蒙-有色白水 2016/5/1 10:38:06
这是sku
内蒙-有色白水 2016/5/1 10:38:26
确切的说，你知识点有点误解
樟溪 2016/5/1 10:38:51
我就是问sku   这些 4g  文字屏  不就是属性值吗
内蒙-有色白水 2016/5/1 10:39:35
比如手机吧，属性有以下这些，iphone，白色，32G，中国联通，armCPU1.5G,支持移动4g等
内蒙-有色白水 2016/5/1 10:39:47
sku是白色，32G，中国联通
内蒙-有色白水 2016/5/1 10:40:18
sku是最小库存单位，和属性一定要严格区分开
内蒙-有色白水 2016/5/1 10:40:39
sku也简单，说白了就是库存表
樟溪 2016/5/1 10:40:52
嗯，同意
内蒙-有色白水 2016/5/1 10:41:48
id    goods_id     sku                                   store    price
1      1                   白色,32G,中国联通         500       4800.00
内蒙-有色白水 2016/5/1 10:41:52
就这样就可以了
樟溪 2016/5/1 10:42:14
这样子 设计 不行吧
内蒙-有色白水 2016/5/1 10:42:29
也就是sku可以随意扩容，一百个SKU属性和没有sku属性是一样的，柯里化和反柯里化即可
樟溪 2016/5/1 10:42:47

内蒙-有色白水 2016/5/1 10:43:06
有神马问题吗？
樟溪 2016/5/1 10:43:25
id    goods_id     sku                                   store    price
1      1                   白色,32G,中国联通         500       4800.00
樟溪 2016/5/1 10:43:31
这样子 你怎么选择
内蒙-有色白水 2016/5/1 10:43:43
id    goods_id     sku                                   store    price
1      1                   白色,32G,中国联通         500       4800.00
2      1                   白色,16G，中国联通        277     4900.00
内蒙-有色白水 2016/5/1 10:43:47
这回明白了吗？
内蒙-有色白水 2016/5/1 10:44:05
一个单品，一个库存单位就是一个sku，一个商品有多个sku
樟溪 2016/5/1 10:44:06
 白色,32G,中国联通      直接是一个字符串了吧
内蒙-有色白水 2016/5/1 10:44:15
柯里化成字符串
樟溪 2016/5/1 10:45:07

樟溪 2016/5/1 10:45:12
那你怎么选择 
广西 -转程序员的农民 2016/5/1 10:45:34
加字段 X XXXL
内蒙-有色白水 2016/5/1 10:45:39
数据库只管逻辑，不管选择
长沙-过程 2016/5/1 10:45:50
这个属性好像要排序，防止存的时候和取得时候不一致
内蒙-有色白水 2016/5/1 10:45:59
白色   
32G   16G
中国联通
内蒙-有色白水 2016/5/1 10:46:02
这样明白了吗
樟溪 2016/5/1 10:46:16
那就问下 能像淘宝那样子选择吗
内蒙-有色白水 2016/5/1 10:46:22
可以啊
广西 -转程序员的农民 2016/5/1 10:46:24
这样子也行..厉害
广西 -转程序员的农民 2016/5/1 10:46:32
确实可以
樟溪 2016/5/1 10:46:43
白色   
32G   16G
中国联通
都字符串了 怎么选择
内蒙-有色白水 2016/5/1 10:47:02
你那个只不过是颜色尺码，而我的sku是白色，容量 运营商
樟溪 2016/5/1 10:47:03
两个表 不够
内蒙-有色白水 2016/5/1 10:47:08
够啊
北京-ystop 2016/5/1 10:47:11
 无限级那个还有一个更好的  左右遍历树存储 查询很简单 可以走索引
内蒙-有色白水 2016/5/1 10:47:15
你没有明白过来而已
内蒙-有色白水 2016/5/1 10:47:37
左右分类实际上更快，但是没有办法直观的表现父子关系
樟溪 2016/5/1 10:48:05
看不到你哪里可以选择
内蒙-有色白水 2016/5/1 10:48:13
我找到这个分类，就知道他爹是谁，他的子孙是谁
樟溪 2016/5/1 10:48:20
这可以说两个选择  
樟溪 2016/5/1 10:48:27
3X1  如果 3X2
内蒙-有色白水 2016/5/1 10:48:39
这样，字符串散列
内蒙-有色白水 2016/5/1 10:49:01
就变成  白色 ，32G， 中国联通   白色 16G 中国联通
内蒙-有色白水 2016/5/1 10:49:12
循环下，重合的直接归纳到一起
内蒙-有色白水 2016/5/1 10:49:26
这样就变成了，白色   32G/16G ，中国联通
内蒙-有色白水 2016/5/1 10:49:37
32G/16G就变成两个选项了
樟溪 2016/5/1 10:49:47
应该还有个 组
樟溪 2016/5/1 10:49:56
表
内蒙-有色白水 2016/5/1 10:50:02
当然，有个sku模型组啊
内蒙-有色白水 2016/5/1 10:50:13
但是单说sku，这就足够了
樟溪 2016/5/1 10:50:29
嗯
内蒙-有色白水 2016/5/1 10:50:52
比如这个sku模型
id  skuname  skuparma
1   颜色           黄色,白色,绿色
樟溪 2016/5/1 10:51:18
嗯，目前我也是这样子搞的==
樟溪 2016/5/1 10:51:26
想好奇 有更好的没
内蒙-有色白水 2016/5/1 10:51:45
这是最简单的搞法了
樟溪 2016/5/1 10:52:14
嗯
北京-ystop 2016/5/1 10:52:29
数据库不直观 但是查询非常方便  如果需要可以在代码里面构造啊
内蒙-有色白水 2016/5/1 10:53:44
左右分类适合对于父子关系不明显的分类使用，如果强调层级，那就不适用了



