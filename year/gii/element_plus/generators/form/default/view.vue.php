<?php

/**
 * This is the template for generating the migration class of a specified table.
 * DO NOT EDIT THIS FILE! It may be regenerated with Gii.
 */

use yii\helpers\Inflector;
use yii\helpers\StringHelper;

/**
 * @var yii\web\View $this
 * @var \year\gii\element_plus\generators\form\Generator $generator
 * @var string $tableName full table name
 * @var \yii\db\TableSchema|false $tableSchema
 */

// FIXME: å…³äºè¡¨å•é»˜è®¤å€¼çš„é—®é¢˜ å¯ä»¥é€šè¿‡å­—æ®µç±»å‹å–åˆ°å…¶é»˜è®¤å€¼ï¼šhttps://github.com/php-toolkit/stdlib/blob/master/src/Type.php#L94
// ä¹Ÿå¯ä»¥ç”¨ActiveRecord å–åˆ°é»˜è®¤å€¼ï¼šhttps://www.yiiframework.com/doc/guide/2.0/en/db-active-record#default-attribute-values

// TODOï¼š å¯¹TS çš„æ”¯æŒ
// todo: php ç±»å‹è½¬æ¢ä¸ºtypescriptç±»å‹ï¼š spatie/typescript-transformer ï½œhttps://typeschema.org/ï½œhttps://hybridly.dev/guide/typescript.html
// ä¸‡ä¸€ç”¨phpåº“æä¸å®š è¿˜å¯ä»¥ä½¿ç”¨è¿›ç¨‹é—´é€šä¿¡ æˆ–è€…webdriverç­‰æ‰‹æ®µé€šè¿‡æ— å¤´æµè§ˆå™¨è®©ç‰¹å®šç½‘ç«™æ¥å®Œæˆè½¬æ¢

$genProp = function ($propName, $propType) {
  $propName = '$' . $propName;
  $propCode = <<<Code
  /**
   * @var $propType
   */
  public {$propName};
  Code;
  return  $propCode;
};

?>

<script  lang="jsx" setup>
import { reactive, ref, toRefs, nextTick } from 'vue'
import dayjs from 'dayjs'

// @see https://blog.csdn.net/weixin_45291937/article/details/125523244
// âš ï¸ v-bind å¯ä»¥é€ä¼ ç»‘å®šå±æ€§åˆ°åº•å±‚æˆ–è€…slotç»„ä»¶ ä¸€è‚¡è„‘å…¨ä¼ è¿‡å»

// @see https://blog.csdn.net/outsider76557/article/details/128933974

// @see https://gitee.com/zhfyjeremy/vue3-vite-ts-template/tree/master/src/components

// import {
//   ElButton,
//   ElIcon,
//   ElTag,
//   ElTooltip,
//   TableV2FixedDir,
// } from 'element-plus'
import { Timer } from '@element-plus/icons-vue'
// import { MyTableColumn } from './components/TableColumn.vue'
import DetailTable from './components/DetailTable.vue'


/**
 * ## å¯ä»¥å‚è€ƒYiiçš„DetailView Widgetè®¾è®¡æ–¹æ³•
 * TODOï¼šformateçš„æ”¯æŒ ï¼Œyiiå®ç°ä¸­éœ€è¦ç³»ç»Ÿformatterçš„å¼•å…¥
 * - "some_field:date" dateæ˜¯ç³»ç»Ÿformatterçš„ä¸€ç§ è¡¨ç¤ºä½¿ç”¨dateåšæ ¼å¼åŒ–å¤„ç†
 * 
 *        <template v-else-if="col.type === 'date'">
 *               <!---åä½æ•°æ—¶é—´æˆ³-->
  *              <span v-if="String(row[col.prop!])?.length <= 10">
   *                 {{ dayjs.unix(row[col.prop!]).format(col.dateFormat ?? 'YYYY-MM-DD') }}
    *            </span>
     *           <!---åä¸‰ä½æ•°æ—¶é—´æˆ³-->
      *          <span v-else>{{ dayjs(row[col.prop!]).format(col.dateFormat ?? 'YYYY-MM-DD') }}</span>
       *     </template>
*
   *   
   * - v-bind å¯¹äº`attribute` æ ·å¼æ–¹é¢çš„æ§åˆ¶ å¯ä»¥ä½¿ç”¨v-bindç»‘å®šåˆ°ç»„ä»¶ä¸Šå»      
 */
const attributes = ref([
    <?php
    foreach ($tableSchema->columns as $column) {
        $format = $generator->generateColumnFormat($column);
        echo "           {\n prop: '" . $column->name . ($format === 'text' ? "" : ":" . $format) . "',\n";
        echo "           lable: '". $labels[$column->name ]. "' \n},\n";
    }
    ?>
   // ------------     ğŸ‘‡ä¸‹é¢æµ‹è¯•ç”¨   --------------- 
  {
    prop: '___tag',
    label: 'slot æµ‹è¯•ğŸ¤¯',
    slot: 'my_slot',
  },
  {
    prop: "date",
    // width: "140",
    align: "left",
    label: "å¸¸è§„åç§°é•¿å­—æ®µ",
    render: ({ row, index }) => {
      return <ElTag>{row.value}</ElTag>;
    },
  },
  {
    prop: "date",
    // width: "140",
    align: "left",
    label: "å¸¸è§„åç§°é•¿å­—æ®µ",
    // TODO: ç¼ºå°‘å¸¸è§æ ¼å¼åŒ–å¤„ç†
    dateFormat: 'YYYY-MM-DD',
    formate: ({ row, index }) => {
      /**
       * dayjs.unix(row.date).format(this.dateFormat ?? 'YYYY-MM-DD')
       */
      return <ElTag>{row.value}</ElTag>;
    },
  },

]);


// props é»˜è®¤æ˜¯å“åº”å¼çš„ 
const props = defineProps({
  title: String,
  detailMode: {
    type: String,
    default: 'dialog', // dailog|drawer
  },
})

const detailViewer = () => {
  if (props.detailMode == 'dialog') {
    return 'el-dialog'
  }
  return 'el-drawer'
}

const dialogVisible = ref(false)
const model = ref()
const openDialog = (row) => {
  dialogVisible.value = true

  if (row) {
    nextTick(() => {

      model.value = row

    })
  }

}

// å¯¼å‡ºæ–¹æ³•
defineExpose({
  openDialog,
})

const handleBeforeClose = (done) => {
  done()
}
const handleClose = () => {
}
const handleCancel = (formEl) => {
  dialogVisible.value = false // è§†å›¾å±‚èµ‹å€¼ä¸éœ€è¦.value!ğŸ˜º
}
const detailTableRef = ref()

</script>

<template>
  <keep-alive>
    <component :is="detailViewer()" size="65%" v-model="dialogVisible" :title="props.title + props.detailMode"
      @close="handleClose" :before-close="handleBeforeClose">
     
      <DetailTable ref="detailTableRef" :attributes="attributes" :model="model">
        <template #my_slot="{ row, index }">
          hiiiiii
          {{ index }}
        </template>
      </DetailTable>

      <template #footer>
        <span class="dialog-footer">
          <el-button @click="handleCancel(formRef)">Cancel</el-button>
        </span>
      </template>

    </component>
  </keep-alive>

</template>
  
 
<style scoped>
.dialog-footer button:first-child {
  margin-right: 10px;
}
</style>